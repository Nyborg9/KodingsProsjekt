@model WebApplication2.Data.GeoChange
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser > UserManager
@{
    ViewData["Title"] = "Detaljer for Rapport";
   

    // Fetch the user associated with this GeoChange
    var applicationUser = await UserManager.FindByIdAsync(Model.UserId);
    var userEmail = applicationUser?.Email ?? "N/A"; // Use "N/A" if email is not found
} 

<h4 class="text-center">Detaljer for Rapport @Model.Id</h4>

<div class="container mt-5">
    <div class="row">
        <!-- Left Side: Map -->
        <div class="col-md-6">
            <div id="map" style="height: 500px; width: 100%; border: 3px solid #ccc;"></div>
        </div>
        
        <!-- Right Side: Details Section -->
        <div class="col-md-6">
            <h6>Beskrivelse:</h6>
            <p>@Model.Description</p>

            <!-- Vise geoJSON informajon -->
            <h6>GeoJSON:</h6>
                <pre style="white-space: pre-wrap; word-wrap: break-word;">@Model.GeoJson</pre>

            <div class="row">
                <div class="col-md-6">
                    <strong>Kommune:</strong>
                    <p>@Model.MunicipalityName</p> <!-- Display Municipality Name -->
                </div>
                <div class="col-md-6">
                    <strong>Kommune Nr.:</strong>
                    <p>@Model.MunicipalityNumber</p> <!-- Display Municipality Number -->
                </div>
                <div class ="col-md-6">
                    <strong>Fylke:</strong>
                    <p>@Model.CountyName</p> <!-- Display County -->
                </div>
            </div>

            <!-- Vise epost til innsender -->
            <h6>Email:</h6>
            <p>@userEmail</p> 

            <!-- Status funksjon kommer her -->
            <h6>Status:</h6>
            <form asp-controller="Caseworker" asp-action="UpdateStatusAndPriority" method="post">
                <div class="form-group">
                    <label for="status">Velg Status:</label>
                    <select id="status" name="status" class="form-control">
                        @foreach (var status in Enum.GetValues(typeof(WebApplication2.Models.ReportStatus)))
                        {
                            <option value="@status" selected="@(status.ToString() == Model.Status?.ToString() ? "selected" : null)">
                                @status
                            </option>
                        }
                    </select>
                </div>

            <!-- Prioritteringsmuligheter kommer her -->
            <h6>Prioritering:</h6>
            <div class="form-group">
                <label for="priority">Velg Prioritet:</label>
                <select id="priority" name="priority" class="form-control">
                    @foreach (var priority in Enum.GetValues(typeof(WebApplication2.Models.PriorityLevel)))
                    {
                        <option value="@priority" selected="@(priority.ToString() == Model.Priority?.ToString() ? "selected" : null)">
                            @priority
                        </option>
                    }
                </select>
            </div>

            <input type="hidden" name="id" value="@Model.Id" />
            <button type="submit" class="btn btn-primary mt-3">Oppdater</button>
        </form>

            <h6>Administrer:</h6>
            |<a asp-controller="Caseworker" asp-action="EditReport" asp-route-id="@Model.Id">Rediger</a> |
            |<a asp-controller="Caseworker" asp-action="DeleteReport" asp-route-id="@Model.Id">Slett</a> |

            
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Initialize the map and set its initial view
        var map = L.map('map').setView([58.164048, 8.004007], 13);

        // Add a tile layer
        L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/{z}/{y}/{x}.png', {
            attribution: 'Kartdata &copy; <a href="https://www.kartverket.no/">Kartverket</a>'
        }).addTo(map);

        // Pass the GeoJSON data as a JavaScript variable
        var geoJsonData = @Json.Serialize(Model.GeoJson);

        // Ensure GeoJSON data exists and is valid
        if (geoJsonData) {
            // Parse the GeoJSON data
            var parsedGeoJson = JSON.parse(geoJsonData);

            // Create a GeoJSON layer
            var geoJsonLayer = L.geoJSON(parsedGeoJson, {
                onEachFeature: function (feature, layer) {
                    // Optionally, bind a popup with the description
                    layer.bindPopup('@Model.Description');
                }
            }).addTo(map);

            // Fit the map to the GeoJSON bounds
            map.fitBounds(geoJsonLayer.getBounds());
        } else {
            console.error("Invalid GeoJSON data.");
        }
    </script>
}